<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify</title>
</head>
<body>
    <textarea id="txt-url" placeholder="URL">http://localhost:8080</textarea><br>
    <!-- <textarea id="txt-sig" placeholder="Signature">ekvK+JvaywBJv95Ueb991JMb/D3beJQ30cjIDHFR35CtgxrkOtYMp3ziINT3XlTVwR75K76XWUjlZom91e/ZFdrxiZyS7dT86gbpnQ48mKPIOow/7Gs588/CkYfyekWX</textarea><br> -->
    <button id="btn-verify">Verify</button>
    <div id="output" style="white-space:pre;"></div>
    
    <script type="module">
        import * as util from './util.mjs';
        
        const txt_url = document.querySelector('#txt-url');
        // const txt_sig = document.querySelector('#txt-sig');
        const btn_verify = document.querySelector('#btn-verify');
        const div_output = document.querySelector('#output');
        
        function log(msg) {
            output.innerHTML += `<div>${msg}</div>`;
        }
        
        async function load_siginfo() {
            log(`Verifying URL: ${txt_url.value}`);
            const url = new URL('./siginfo.json', txt_url.value).href;
            const siginfo = await util.fetch_json(url);
            log(`Siginfo: ${url}`);
            // TODO: no siginfo found
            return siginfo;
        }
        
        function process_sitemap(files) {
            return files.map(f => util.make_url(f, txt_url.value));
        }
        
        async function verify() {
            output.innerHTML = '';
            const siginfo = await load_siginfo();
            console.log(siginfo);
            
            // TODO: check that siginfo is signed
            // TODO: check that timestamp is signed
            // TODO: check that signed files are on the checked domain
            
            const sig = await util.fetch_text(util.make_url(siginfo.signature_url , txt_url.value));
            log(`Signature: ${sig}`);
            
            const public_key_url = new URL('../crypto/public_key.pem', location.href).href;
            const public_key = await util.load_public_key(public_key_url);
            log(`Public key: ${public_key_url}`);
            
            const files = process_sitemap(siginfo.sitemap);
            log(`Files to verify: ${files.length}`)
            const data_buffers = await Promise.all(files.map(path => {
                log(`Verifying: ${path}`);
                return util.fetch_ab(path);
            }));
            
            const data = util.join_buffers(data_buffers);
            log(`Total bytes to verify: ${data.byteLength}`);
            
            const valid = await util.verify(public_key, sig, data);
            if (valid) {
                log(`VALID\n\n`);
                log(`<img src="${util.make_url(siginfo.metadata.image_url, txt_url.value)}" style="max-width:200px;"/>`)
                log(JSON.stringify(siginfo.metadata));
                const timestamp = await util.fetch_text(util.make_url(siginfo.timestamp_url , txt_url.value));
                log(`Signature Timestamp: ${timestamp}`)
                
            } else {
                log(`NOT VALID`);
            }
        }
        
        btn_verify.onclick = verify;
        
        /* 
            VALID means:
            * The data is complete and unchanged from it's original state (Integrity)
            * The data is verified to be from Process Studio (Authenticity)
         
            INVALID means:
            * The data was changed or tammpered with
            * The signature was changed or tampered with
        */
        
        const query = new URLSearchParams(window.location.search);
        const url = query.get('url');
        if (url) { txt_url.value = url; }
        
        verify();
        
    </script>
    
</body>
</html>